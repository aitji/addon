name: auto update download.mcpack

on:
  push:
    branches:
      - main

jobs:
  check-and-update:
    if: ${{ !contains(github.event.head_commit.message, '[bot] update download.mcpack') }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: run update script
        id: script
        run: |
          START_TIME=$(date +%s)
          python selfUpdate.py > update_log.txt 2>&1
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
          cat update_log.txt

      - name: stage mcpack changes
        run: |
          git add '**/*.mcpack' || true

      - name: collect detailed changes
        id: details
        run: |
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "(âœ—) no .mcpack changes detected"
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          COUNT=$(git diff --cached --name-only '**/*.mcpack' | wc -l)
          echo "changed_files=$COUNT" >> $GITHUB_OUTPUT

          ADDON_COUNT=$(find . -type d -name "addon" | wc -l)
          echo "addon_folders=$ADDON_COUNT" >> $GITHUB_OUTPUT

          DETAILS=""
          ADDED_FILES=""
          MODIFIED_FILES=""
          ADDED_COUNT=0
          MODIFIED_COUNT=0

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              SIZE=$(ls -lh "$file" | awk '{print $5}')
              MODIFIED_DATE=$(date -r "$file" +'%Y-%m-%d %H:%M')

              if git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
                MODIFIED_FILES="${MODIFIED_FILES}| (ğŸ“) \`${file}\` | ${SIZE} | ${MODIFIED_DATE} |\n"
                MODIFIED_COUNT=$((MODIFIED_COUNT + 1))
              else
                ADDED_FILES="${ADDED_FILES}| (âœ¨) \`${file}\` | ${SIZE} | ${MODIFIED_DATE} |\n"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              fi

              DETAILS="${DETAILS}| \`${file}\` | ${SIZE} | ${MODIFIED_DATE} |\n"
            fi
          done < <(git diff --cached --name-only '**/*.mcpack')

          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "modified_count=$MODIFIED_COUNT" >> $GITHUB_OUTPUT

          echo "file_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "added_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "modified_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$MODIFIED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          COMMIT_MSG=$(git log -1 --pretty=%B | head -n1)
          echo "commit_sha=$(git rev-parse HEAD | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "commit_full_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

          TOTAL_SIZE=0
          MAX_SIZE=0
          MIN_SIZE=999999999
          MAX_FILE=""
          MIN_FILE=""

          while IFS= read -r file; do
            if [ -f "$file" ]; then
              FILE_SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
              TOTAL_SIZE=$((TOTAL_SIZE + FILE_SIZE))
              
              if [ $FILE_SIZE -gt $MAX_SIZE ]; then
                MAX_SIZE=$FILE_SIZE
                MAX_FILE="$file"
              fi
              
              if [ $FILE_SIZE -lt $MIN_SIZE ] && [ $FILE_SIZE -gt 0 ]; then
                MIN_SIZE=$FILE_SIZE
                MIN_FILE="$file"
              fi
            fi
          done < <(git diff --cached --name-only '**/*.mcpack')

          if [ $TOTAL_SIZE -gt 1048576 ]; then
            TOTAL_SIZE_HR="$(echo "scale=2; $TOTAL_SIZE/1048576" | bc)mb"
          elif [ $TOTAL_SIZE -gt 1024 ]; then
            TOTAL_SIZE_HR="$(echo "scale=2; $TOTAL_SIZE/1024" | bc)kb"
          else
            TOTAL_SIZE_HR="${TOTAL_SIZE}b"
          fi

          if [ $MAX_SIZE -gt 1048576 ]; then
            MAX_SIZE_HR="$(echo "scale=2; $MAX_SIZE/1048576" | bc)mb"
          elif [ $MAX_SIZE -gt 1024 ]; then
            MAX_SIZE_HR="$(echo "scale=2; $MAX_SIZE/1024" | bc)kb"
          else
            MAX_SIZE_HR="${MAX_SIZE}b"
          fi

          if [ $MIN_SIZE -eq 999999999 ]; then
            MIN_SIZE=0
          fi

          if [ $MIN_SIZE -gt 1048576 ]; then
            MIN_SIZE_HR="$(echo "scale=2; $MIN_SIZE/1048576" | bc)mb"
          elif [ $MIN_SIZE -gt 1024 ]; then
            MIN_SIZE_HR="$(echo "scale=2; $MIN_SIZE/1024" | bc)kb"
          else
            MIN_SIZE_HR="${MIN_SIZE}b"
          fi

          if [ $COUNT -gt 0 ]; then
            AVG_SIZE=$((TOTAL_SIZE / COUNT))
            if [ $AVG_SIZE -gt 1048576 ]; then
              AVG_SIZE_HR="$(echo "scale=2; $AVG_SIZE/1048576" | bc)mb"
            elif [ $AVG_SIZE -gt 1024 ]; then
              AVG_SIZE_HR="$(echo "scale=2; $AVG_SIZE/1024" | bc)kb"
            else
              AVG_SIZE_HR="${AVG_SIZE}b"
            fi
          else
            AVG_SIZE_HR="0b"
          fi

          echo "total_size=$TOTAL_SIZE_HR" >> $GITHUB_OUTPUT
          echo "avg_size=$AVG_SIZE_HR" >> $GITHUB_OUTPUT
          echo "max_size=$MAX_SIZE_HR" >> $GITHUB_OUTPUT
          echo "min_size=$MIN_SIZE_HR" >> $GITHUB_OUTPUT
          echo "max_file=$MAX_FILE" >> $GITHUB_OUTPUT
          echo "min_file=$MIN_FILE" >> $GITHUB_OUTPUT

          TOTAL_MCPACK=$(find . -name "*.mcpack" | wc -l)
          echo "total_mcpack=$TOTAL_MCPACK" >> $GITHUB_OUTPUT

          echo "(âœ“) detected $COUNT .mcpack file(s) changed ($TOTAL_SIZE_HR total)"

      - name: create pull request
        if: steps.details.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot-update-mcpack
          base: main
          title: "(ğŸ¤–) auto-update: ${{ steps.details.outputs.changed_files }} .mcpack file(s) â€¢ run #${{ github.run_number }}"
          body: |
            # package auto-update (ğŸ¤–)

            <div align="center">

            ![status](https://img.shields.io/badge/status-ready%20for%20review-success?style=for-the-badge)
            ![files](https://img.shields.io/badge/files%20changed-${{ steps.details.outputs.changed_files }}-blue?style=for-the-badge)
            ![size](https://img.shields.io/badge/total%20size-${{ steps.details.outputs.total_size }}-orange?style=for-the-badge)

            </div>

            ---

            ## (ğŸ“Š) update statistics

            | metric | value | details |
            |--------|-------|---------|
            | ğŸ“¦ **files changed** | **${{ steps.details.outputs.changed_files }}** | (âœ¨) ${{ steps.details.outputs.added_count }} new, (ğŸ“) ${{ steps.details.outputs.modified_count }} modified |
            | ğŸ’¾ **total size** | **${{ steps.details.outputs.total_size }}** | combined size of all changes |
            | ğŸ“ **average size** | **${{ steps.details.outputs.avg_size }}** | per file average |
            | ğŸ“ˆ **largest file** | **${{ steps.details.outputs.max_size }}** | `${{ steps.details.outputs.max_file }}` |
            | ğŸ“‰ **smallest file** | **${{ steps.details.outputs.min_size }}** | `${{ steps.details.outputs.min_file }}` |
            | ğŸ“ **addon folders** | **${{ steps.details.outputs.addon_folders }}** | total scanned |
            | ğŸ—‚ï¸ **total .mcpack** | **${{ steps.details.outputs.total_mcpack }}** | in repository |
            | âš¡ **process time** | **${{ steps.script.outputs.duration }}** | script execution |

            ---

            ## (ğŸ“¦) changed files

            <details open>
            <summary><b>(ğŸ”) all changes</b></summary>
            <br>

            | file path | size | last modified |
            |-----------|------|---------------|
            ${{ steps.details.outputs.file_details }}

            </details>

            ${{ steps.details.outputs.added_count > 0 && format('
            <details>
            <summary><b>(âœ¨) new files ({0})</b></summary>
            <br>

            | file path | size | created |
            |-----------|------|---------|
            {1}

            </details>', steps.details.outputs.added_count, steps.details.outputs.added_files) || '' }}

            ${{ steps.details.outputs.modified_count > 0 && format('
            <details>
            <summary><b>(ğŸ› ï¸) modified files ({0})</b></summary>
            <br>

            | file path | size | modified |
            |-----------|------|----------|
            {1}

            </details>', steps.details.outputs.modified_count, steps.details.outputs.modified_files) || '' }}

            ---

            ## (ğŸ) wut triggered this update?

            | detail | value |
            |--------|-------|
            | (ğŸ‘¤) **author** | @${{ github.actor }} |
            | **commit message** | `${{ steps.details.outputs.commit_msg }}` |
            | **commit(sha)** | [`${{ steps.details.outputs.commit_sha }}`](https://github.com/${{ github.repository }}/commit/${{ steps.details.outputs.commit_full_sha }}) |
            | **timestamp** | `${{ steps.details.outputs.commit_date }}` |
            | **workflow** | [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
            | **branch** | `${{ github.ref_name }}` |

            ---

            <details>
            <summary><b>technical details</b></summary>

            - **script**: `/selfUpdate.py`
            - **python version**: 3.11
            - **compression**: zip_deflated
            - **change detection**: file checksum comparison (filecmp)
            - **runner**: ubuntu-latest

            </details>

            ---

            <div align="center">

            **(ğŸ¯) quick actions**

            [ğŸ“‹ view workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ 
            [ğŸ“Š compare changes](https://github.com/${{ github.repository }}/compare/main...bot-update-mcpack)

            </div>

            ---

            <sub>ğŸ¤– automatically generated by **github actions** â€¢ workflow run #${{ github.run_number }} â€¢ generated at ${{ steps.details.outputs.commit_date }}</sub>

            **ğŸ‘¨â€ğŸ’» reviewer:** @aitji
          commit-message: |
            [bot] update download.mcpack

            ğŸ“¦ updated ${{ steps.details.outputs.changed_files }} file(s)
            ğŸ’¾ total size: ${{ steps.details.outputs.total_size }}
            ğŸ‘¤ triggered by: @${{ github.actor }}
            ğŸ”— commit: ${{ steps.details.outputs.commit_sha }}
          delete-branch: true
          labels: |
            ğŸ¤– bot
            ğŸ“¦ auto-update

      - name: no changes
        if: steps.details.outputs.has_changes == 'false'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "(âœ…) no download.mcpack updates needed"
          echo "(ğŸ“Š) all packages are up to date!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
