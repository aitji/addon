name: Trigger Python and Create PR

on:
  push:
    branches:
      - main

jobs:
  run-script:
    if: ${{ !contains(github.event.head_commit.message, '[bot] update Download.mcpack') }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Create update branch
        run: |
          BRANCH="bot-update"
          git checkout -B "$BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run update script
        run: python selfUpdate.py

      - name: Stage and check for changes
        id: changes
        run: |
          git add -A
          COUNT=$(git diff --cached --name-only | wc -l)
          echo "changed_files=$COUNT" >> $GITHUB_OUTPUT
          if [ "$COUNT" -eq 0 ]; then
            echo "No changes detected, exiting."
            exit 0
          fi

      - name: Commit and push changes
        run: |
          git commit -m "[bot] update Download.mcpack" \
                     -m "trigger: @${{ github.actor }}" \
                     -m "path: /selfUpdate.py" \
                     -m "total: ${{ steps.changes.outputs.changed_files }} file(s)"
          git push -u origin "$BRANCH" --force

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot-update
          base: main
          title: "[bot] update Download.mcpack"
          body: |
            **Auto Update Triggered by:** @${{ github.actor }}
            **Script Path:** `/selfUpdate.py`
            **Files Changed:** `${{ steps.changes.outputs.changed_files }}` file(s)

            Please review and approve: @aitji
          commit-message: "[bot] update Download.mcpack"
